<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Panel de usuario EcoAcción">
    <meta name="author" content="">
    <title>EcoAcción - Panel de Usuario</title>

    <!-- Fuentes y estilos -->
    <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,300,400,700,900" rel="stylesheet">
    <link href="css/sb-admin-2.min.css" rel="stylesheet">
    
    <style>
        /* Estilos adicionales para mejorar la experiencia */
        .card-counter {
            transition: all 0.3s ease;
        }
        .card-counter:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .ranking-table tr:nth-child(1) {
            background-color: rgba(255, 215, 0, 0.1);
        }
        .ranking-table tr:nth-child(2) {
            background-color: rgba(192, 192, 192, 0.1);
        }
        .ranking-table tr:nth-child(3) {
            background-color: rgba(205, 127, 50, 0.1);
        }
    </style>
</head>

<body id="page-top">

<div id="wrapper">

    <!-- Sidebar -->
    <ul class="navbar-nav bg-gradient-success sidebar sidebar-dark accordion" id="accordionSidebar">
        <a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
            <div class="sidebar-brand-icon"><i class="fas fa-leaf"></i></div>
            <div class="sidebar-brand-text mx-3">EcoAcción</div>
        </a>
        <hr class="sidebar-divider my-0">
        <li class="nav-item active">
            <a class="nav-link" href="index.html"><i class="fas fa-fw fa-home"></i><span>Inicio</span></a>
        </li>
        <hr class="sidebar-divider">
        <div class="sidebar-heading">Participación</div>
        <li class="nav-item"><a class="nav-link" href="desafios.html"><i class="fas fa-fw fa-seedling"></i><span>Desafíos Disponibles</span></a></li>
        <li class="nav-item"><a class="nav-link" href="participaciones.html"><i class="fas fa-fw fa-check"></i><span>Mis Participaciones</span></a></li>
        <li class="nav-item"><a class="nav-link" href="ranking.html"><i class="fas fa-fw fa-trophy"></i><span>Ranking</span></a></li>
        <hr class="sidebar-divider">
        <div class="sidebar-heading">Administración</div>
        <li class="nav-item"><a class="nav-link" href="gestion_usuarios.html"><i class="fas fa-fw fa-users-cog"></i><span>Gestión de Usuarios</span></a></li>
        <hr class="sidebar-divider d-none d-md-block">
    </ul>
    <!-- Fin Sidebar -->

    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">

            <!-- Navbar -->
            <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3"><i class="fa fa-bars"></i></button>
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <span class="nav-link text-primary" id="userPoints">
                            <i class="fas fa-coins mr-1"></i> <span id="userPointsValue">0</span> puntos
                        </span>
                    </li>
                    <div class="topbar-divider d-none d-sm-block"></div>
                    <li class="nav-item dropdown no-arrow">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                           data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="mr-2 d-none d-lg-inline text-gray-600 small" id="nombreUsuario">Usuario</span>
                            <img class="img-profile rounded-circle" src="img/undraw_profile.svg" id="userAvatar">
                        </a>
                        <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                             aria-labelledby="userDropdown">
                            <a class="dropdown-item" href="#" data-toggle="modal" data-target="#profileModal">
                                <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>Perfil
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#" data-toggle="modal" data-target="#logoutModal">
                                <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>Cerrar Sesión
                            </a>
                        </div>
                    </li>
                </ul>
            </nav>

            <div class="container-fluid">
                <div class="d-sm-flex align-items-center justify-content-between mb-4">
                    <h1 class="h3 mb-0 text-gray-800">Panel de Usuario</h1>
                    <a href="desafios.html" class="d-none d-sm-inline-block btn btn-sm btn-success shadow-sm">
                        <i class="fas fa-seedling fa-sm text-white-50"></i> Ver Desafíos
                    </a>
                </div>

                <!-- Alertas -->
                <div id="globalAlert" class="alert d-none alert-dismissible fade show" role="alert">
                    <span id="alertMessage"></span>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <!-- Cards -->
                <div class="row">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-primary shadow h-100 py-2 card-counter">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Desafíos Activos</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="desafiosActivos">
                                            <div class="loading-spinner-sm text-primary"></div>
                                        </div>
                                    </div>
                                    <div class="col-auto"><i class="fas fa-tree fa-2x text-gray-300"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-success shadow h-100 py-2 card-counter">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Desafíos Completados</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="desafiosCompletados">
                                            <div class="loading-spinner-sm text-success"></div>
                                        </div>
                                    </div>
                                    <div class="col-auto"><i class="fas fa-check-circle fa-2x text-gray-300"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-info shadow h-100 py-2 card-counter">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Usuarios Registrados</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="usuariosRegistrados">
                                            <div class="loading-spinner-sm text-info"></div>
                                        </div>
                                    </div>
                                    <div class="col-auto"><i class="fas fa-users fa-2x text-gray-300"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card border-left-warning shadow h-100 py-2 card-counter">
                            <div class="card-body">
                                <div class="row no-gutters align-items-center">
                                    <div class="col mr-2">
                                        <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Mi Ranking</div>
                                        <div class="h5 mb-0 font-weight-bold text-gray-800" id="rankingUsuario">
                                            <div class="loading-spinner-sm text-warning"></div>
                                        </div>
                                    </div>
                                    <div class="col-auto"><i class="fas fa-trophy fa-2x text-gray-300"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenido principal -->
                <div class="row">
                    <!-- Gráfico de progreso -->
                    <div class="col-xl-8 col-lg-7">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                <h6 class="m-0 font-weight-bold text-primary">Mi Progreso Mensual</h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-area">
                                    <canvas id="myProgressChart"></canvas>
                                </div>
                                <div class="mt-3 text-center small">
                                    <span class="mr-2"><i class="fas fa-circle text-primary"></i> Desafíos Completados</span>
                                    <span class="mr-2"><i class="fas fa-circle text-success"></i> Puntos Obtenidos</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Próximos desafíos -->
                    <div class="col-xl-4 col-lg-5">
                        <div class="card shadow mb-4">
                            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                                <h6 class="m-0 font-weight-bold text-primary">Próximos Desafíos</h6>
                            </div>
                            <div class="card-body">
                                <div id="proximosDesafios">
                                    <div class="text-center py-4">
                                        <div class="loading-spinner text-primary mb-2"></div>
                                        <p class="small">Cargando desafíos...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de ranking -->
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Top 10 - Ranking General</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered ranking-table" id="tablaRanking" width="100%" cellspacing="0">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Posición</th>
                                        <th>Nombre</th>
                                        <th>Puntos</th>
                                        <th>Desafíos Completados</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="4" class="text-center">
                                            <div class="loading-spinner text-primary mb-2"></div>
                                            Cargando ranking...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="sticky-footer bg-white">
            <div class="container my-auto">
                <div class="copyright text-center my-auto">
                    <span>EcoAcción &copy; 2025 - Conectado con ASP.NET Core</span>
                </div>
            </div>
        </footer>
    </div>
</div>

<!-- Modal logout -->
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">¿Listo para salir?</h5>
                <button class="close" type="button" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">Selecciona "Cerrar Sesión" para salir de tu cuenta.</div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancelar</button>
                <a class="btn btn-success" href="login.html" onclick="logout()">Cerrar Sesión</a>
            </div>
        </div>
    </div>
</div>

<!-- Modal perfil -->
<div class="modal fade" id="profileModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mi Perfil</h5>
                <button class="close" type="button" data-dismiss="modal"><span>&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center">
                        <img class="img-profile rounded-circle mb-3" src="img/undraw_profile.svg" id="profileAvatar" style="width: 150px; height: 150px;">
                        <h5 id="profileName">Usuario</h5>
                        <p class="text-muted" id="profileEmail">usuario@ejemplo.com</p>
                        <div class="badge badge-success p-2" id="profileLevel">Nivel: Principiante</div>
                    </div>
                    <div class="col-md-8">
                        <h6 class="text-primary">Estadísticas</h6>
                        <div class="row mb-3">
                            <div class="col-6">
                                <small>Puntos Totales</small>
                                <h4 id="profileTotalPoints">0</h4>
                            </div>
                            <div class="col-6">
                                <small>Desafíos Completados</small>
                                <h4 id="profileCompletedChallenges">0</h4>
                            </div>
                        </div>
                        
                        <h6 class="text-primary mt-4">Mi Impacto Ambiental</h6>
                        <div class="impact-stats">
                            <div class="d-flex justify-content-between mb-2">
                                <span>CO₂ reducido (kg)</span>
                                <strong id="profileCO2">0</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Agua ahorrada (L)</span>
                                <strong id="profileWater">0</strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Residuos reciclados (kg)</span>
                                <strong id="profileWaste">0</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts base -->
<script src="vendor/jquery/jquery.min.js"></script>
<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="vendor/jquery-easing/jquery.easing.min.js"></script>
<script src="js/sb-admin-2.min.js"></script>
<script src="vendor/chart.js/Chart.min.js"></script>

<!-- Configuración API -->
<script>
    // Configuración de la API
    const API_BASE = "https://localhost:7258/api";
    const token = localStorage.getItem("token");
    const usuario = JSON.parse(localStorage.getItem("usuario") || "{}");

    // Verificar autenticación
    if (!token) {
        window.location.href = "login.html";
    }

    // Mostrar información del usuario
    document.getElementById("nombreUsuario").innerText = usuario.nombre || "Invitado";
    document.getElementById("userPointsValue").innerText = usuario.puntos || 0;
    
    // Funciones globales
    function mostrarAlerta(mensaje, tipo = "danger") {
        const alert = document.getElementById("globalAlert");
        const alertMessage = document.getElementById("alertMessage");
        
        alert.className = `alert alert-${tipo} alert-dismissible fade show`;
        alertMessage.textContent = mensaje;
        alert.classList.remove("d-none");
        
        // Ocultar automáticamente después de 5 segundos
        setTimeout(() => {
            alert.classList.add("d-none");
        }, 5000);
    }

    function logout() {
        localStorage.removeItem("usuario");
        localStorage.removeItem("token");
    }

    // Cargar datos del dashboard
    async function cargarDashboard() {
        try {
            const response = await fetch(`${API_BASE}/dashboard`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                }
            });

            if (response.status === 401) {
                // Token expirado o inválido
                mostrarAlerta("Sesión expirada. Por favor, inicia sesión nuevamente.");
                setTimeout(() => {
                    logout();
                    window.location.href = "login.html";
                }, 2000);
                return;
            }

            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            
            // Actualizar tarjetas
            document.getElementById("desafiosActivos").innerText = data.desafiosActivos || 0;
            document.getElementById("desafiosCompletados").innerText = data.desafiosCompletados || 0;
            document.getElementById("usuariosRegistrados").innerText = data.usuariosRegistrados || 0;
            document.getElementById("rankingUsuario").innerText = data.rankingUsuario ? `#${data.rankingUsuario}` : "-";
            
            // Actualizar puntos de usuario
            if (data.puntosUsuario) {
                document.getElementById("userPointsValue").innerText = data.puntosUsuario;
                usuario.puntos = data.puntosUsuario;
                localStorage.setItem("usuario", JSON.stringify(usuario));
            }
            
            // Cargar ranking
            if (data.ranking && data.ranking.length > 0) {
                const tbody = document.querySelector("#tablaRanking tbody");
                tbody.innerHTML = "";
                
                data.ranking.forEach((user, index) => {
                    const tr = document.createElement("tr");
                    // Destacar al usuario actual
                    if (user.id === usuario.id) {
                        tr.classList.add("table-info");
                    }
                    tr.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${user.nombre} ${user.id === usuario.id ? '(Tú)' : ''}</td>
                        <td>${user.puntos}</td>
                        <td>${user.desafiosCompletados}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            // Cargar próximos desafíos
            if (data.proximosDesafios && data.proximosDesafios.length > 0) {
                const container = document.getElementById("proximosDesafios");
                container.innerHTML = "";
                
                data.proximosDesafios.forEach(desafio => {
                    const div = document.createElement("div");
                    div.className = "mb-3 p-3 border rounded";
                    div.innerHTML = `
                        <h6 class="text-success">${desafio.titulo}</h6>
                        <p class="small text-muted mb-1">${desafio.descripcion}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge badge-primary">+${desafio.puntos} puntos</span>
                            <small class="text-muted">${desafio.fechaFin}</small>
                        </div>
                    `;
                    container.appendChild(div);
                });
            } else {
                document.getElementById("proximosDesafios").innerHTML = `
                    <p class="text-center text-muted">No hay desafíos próximos</p>
                `;
            }
            
            // Inicializar gráfico de progreso si hay datos
            if (data.progresoMensual) {
                inicializarGraficoProgreso(data.progresoMensual);
            }
            
        } catch (error) {
            console.error("Error al cargar el dashboard:", error);
            mostrarAlerta("Error al conectar con el servidor. Por favor, intenta nuevamente.");
        }
    }
    
    // Inicializar gráfico de progreso
    function inicializarGraficoProgreso(datos) {
        const ctx = document.getElementById('myProgressChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: datos.labels || ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                datasets: [{
                    label: 'Desafíos Completados',
                    data: datos.desafios || [5, 8, 12, 6, 9, 15],
                    borderColor: '#4e73df',
                    backgroundColor: 'rgba(78, 115, 223, 0.05)',
                    fill: true,
                    tension: 0.3
                }, {
                    label: 'Puntos Obtenidos',
                    data: datos.puntos || [50, 80, 120, 60, 90, 150],
                    borderColor: '#1cc88a',
                    backgroundColor: 'rgba(28, 200, 138, 0.05)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
    
    // Cargar datos del perfil
    async function cargarDatosPerfil() {
        try {
            const response = await fetch(`${API_BASE}/usuarios/perfil`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                }
            });
            
            if (response.ok) {
                const perfil = await response.json();
                
                // Actualizar modal de perfil
                document.getElementById("profileName").innerText = perfil.nombre || usuario.nombre;
                document.getElementById("profileEmail").innerText = perfil.email || usuario.email;
                document.getElementById("profileTotalPoints").innerText = perfil.puntosTotales || 0;
                document.getElementById("profileCompletedChallenges").innerText = perfil.desafiosCompletados || 0;
                document.getElementById("profileLevel").innerText = `Nivel: ${perfil.nivel || "Principiante"}`;
                
                // Actualizar estadísticas de impacto
                document.getElementById("profileCO2").innerText = perfil.impacto?.co2Reducido || 0;
                document.getElementById("profileWater").innerText = perfil.impacto?.aguaAhorrada || 0;
                document.getElementById("profileWaste").innerText = perfil.impacto?.residuosReciclados || 0;
            }
        } catch (error) {
            console.error("Error al cargar perfil:", error);
        }
    }
    
    // Cuando el modal de perfil se muestra, cargar los datos
    $('#profileModal').on('show.bs.modal', function () {
        cargarDatosPerfil();
    });

    // Iniciar la carga de datos cuando el documento esté listo
    $(document).ready(function() {
        cargarDashboard();
    });
</script>
</body>
</html>